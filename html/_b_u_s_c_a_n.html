<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LibLaboCesson: Le BUS CAN</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">LibLaboCesson
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_b_u_s_c_a_n.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Le BUS CAN</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md5"></a>
Introduction</h1>
<h2><a class="anchor" id="autotoc_md6"></a>
Description du bus CAN</h2>
<p>Le Bus CAN est une technologie utilisée dans ledomaine automobile pour echanger des informations entre les différents organes de la voiture.<br  />
 Il est utilisé par le Labo Cesson pour échanger des informations entre le poste de pilotage et le robot</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Implémentation matérielle</h2>
<p>Le bus CAN est mis en oeuvre en utilisant le <a href="https://handsontec.com/dataspecs/module/Networking/MCP2515%20CAN%20Module.pdf" target="_blank" rel="noopener">Module MCP2515</a></p>
<p>Ce module a une horloge à 8Mhz qui limite le débit mais est largement suffisant car autorise un débit de 125Kbits/sec.</p>
<p>Ce qui permet typiquement d'échanger d'échanger théoriquement plus de 1000 messages par seconde.</p>
<p>Dans l'implémentation actuelle, la librairie utilisée est la librairie <a href="https://github.com/Seeed-Studio/Seeed_Arduino_CAN" target="_blank" rel="noopener">CAN_BUS_Shield par Seed Studio</a></p>
<p>Le module <a href="https://fr.pinterest.com/pin/usb-liltech-canable-plildebugger-outil-de-dbogage-lilbus-pour-linux-win10-11-typec-usb-degraine-in-2025--4593742097083648000/" target="_blank" rel="noopener">USB LilTech, CANable PLilDebugger Outil de débogage Lilbus</a> avec le logiciel <a href="https://www.peak-system.com/Software.68.0.html" target="_blank" rel="noopener">PCAN-View</a></p>
<h1><a class="anchor" id="autotoc_md8"></a>
Description du protocole</h1>
<h2><a class="anchor" id="autotoc_md9"></a>
Format général</h2>
<p>Le protocole est du type commande/réponse. Une nouvelle commande ne peut être envoyée que lorsque la réponse à la précédente a été reçue.</p>
<p>Le protocole est décrit dans le fichier <a class="el" href="_lib_can_prot_def_8h.html">LibCanProtDef.h</a></p>
<p>Une commande est composée des octets suivants:</p>
<ul>
<li>un MagicTag (0xC7) permettant de s'assurer que l'on a bien le début d'une commande ou d'une réponse<br  />
 Le cas échéant, en cas de désynchronisation, il pourrait être possible d'effecteur une resynchronisation<br  />
<br  />
</li>
<li>une Commande/Réponse avec le bit de poids fort à 0 pour une commande et à 1 pour une réponse<br  />
 Cela autorise jusqu'à 128 commandes différentes<br  />
 Le code de la réponse est égale au code de la commande<br  />
<br  />
</li>
<li>Le nombre d'octets suivant cet octet<br  />
 La longueur maximum d'une commande est de <a class="el" href="_lib_can_8h.html#aba38143fa913a3fac654a6b1ed590432">BUS_CAN_MESSAGE_MAX_SIZE</a> octets, ce nombre ne doit donc pas excéder cette valeur diminuée de 3<br  />
<br  />
</li>
<li>Les données associées à la commande dont le nombre et le rôle dépendent de la commande</li>
</ul>
<dl class="section warning"><dt>Warning</dt><dd>Une réponse utilise le même code que la commande associée ce qui permet de s'assurer que l'on est bien synchronisé. Mais si l'on envoi de manière continue la même commande, il peut y avoir une désynchronisation jusqu'à l'envoi d'une commande différente</dd></dl>
<h2><a class="anchor" id="autotoc_md10"></a>
Description des commandes</h2>
<p>Il existe deux types de commandes:</p>
<ul>
<li>Des commandes permettant d'adresser directement le matériel de la carte Robot<br  />
 Par exemple, la commande BUS_CAN_SET_PIN_DIGITAL permet de gérer directement un port en utilisant son numéro de pin</li>
<li>Des commandes utlisant un niveau d'abstraction et permettant de gérer un organe de la carte Robot<br  />
 Par exemple, la commande BUS_CAN_SET_RELAY peremt de gérer l'état d'un relai sans connaitre le port qui lui est associé<br  />
</li>
</ul>
<p>Les commandes avec un niveau d'abstraction permettent d'avoir des logiciels de contrôle indépendants de la carte présente sur la carte Robot<br  />
 Par exemple, le logiciel de gestion du joystick s'appuie sur la commande BUS_CAN_SET_MOTEUR_1 et est identique pour les deux robots, bien que l'un soit équipé d'une carte Arduino Mega Mini et l'autre d'un ESP32-S2</p>
<p>Les commandes sont décrites dans le fichier <a class="el" href="_lib_can_prot_def_8h.html">LibCanProtDef.h</a></p>
<h1><a class="anchor" id="autotoc_md11"></a>
Implémentation logicielle</h1>
<h2><a class="anchor" id="autotoc_md12"></a>
Organisation des classes</h2>
<p>L'ensemble des classes gérant le bus CAN sont présentes dans les fichiers</p>
<ul>
<li><a class="el" href="_lib_can_8h.html">LibCan.h</a> qui contient la définition des classes</li>
<li><a class="el" href="_lib_can_prot_def_8h.html">LibCanProtDef.h</a> qui contient la définition des commandes</li>
<li><a class="el" href="_lib_can_8cpp.html">LibCan.cpp</a> qui contient l'implémentation des classes</li>
</ul>
<p>Il existe 4 classes :</p>
<ul>
<li>la classe <a class="el" href="class_lib_can2515.html">LibCan2515</a> qui permet de gérer les couches basses du bus CAN Initialisation du matériel, envoi d'un message, lecture d'un message</li>
<li>la classe <a class="el" href="class_lib_can_prot_send.html">LibCanProtSend</a> qui est utilisée par le logiciel pilote pour envoyer des commandes et lire des réponses</li>
<li>la classe <a class="el" href="class_lib_can_prot_recv.html">LibCanProtRecv</a> qui est utilisé par le robot pour lire des commandes, les exécuter et retoourner une réponse</li>
<li>la classe <a class="el" href="class_lib_can_prot_common.html">LibCanProtCommon</a> qui contient des fonctions communes aux deux classes <a class="el" href="class_lib_can_prot_send.html">LibCanProtSend</a> et <a class="el" href="class_lib_can_prot_recv.html">LibCanProtRecv</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Mise en oeuvre de la classe LibCanProtSend</h2>
<p>La classe <a class="el" href="class_lib_can_prot_send.html">LibCanProtSend</a> est générique et à besoin de connaitre l'objet en charge de la gestion des couches basses<br  />
 Une initialisation typique est donc la suivante :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_lib_can_8h.html">LibCan.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#define CAN_BUS_CS_PIN 49</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="class_lib_can2515.html">LibCan2515</a>     canBus(CAN_BUS_CS_PIN);</div>
<div class="line"><a class="code hl_class" href="class_lib_can_prot_send.html">LibCanProtSend</a> canProt;</div>
<div class="ttc" id="a_lib_can_8h_html"><div class="ttname"><a href="_lib_can_8h.html">LibCan.h</a></div><div class="ttdoc">Le fichier de définition des classes LibCan2515 et LibCanProt.</div></div>
<div class="ttc" id="aclass_lib_can2515_html"><div class="ttname"><a href="class_lib_can2515.html">LibCan2515</a></div><div class="ttdoc">La librairie LibCan2515 permet de gérer un bus CAN en émission et en réception.</div><div class="ttdef"><b>Definition</b> LibCan.h:24</div></div>
<div class="ttc" id="aclass_lib_can_prot_send_html"><div class="ttname"><a href="class_lib_can_prot_send.html">LibCanProtSend</a></div><div class="ttdoc">La librairie LibCanProtSend permet de gérer le protocole utilisé entre le poste de commande du robot ...</div><div class="ttdef"><b>Definition</b> LibCan.h:148</div></div>
</div><!-- fragment --><p>Puis dans le setup(), il faut donner à l'objet canProt la référence de l'objet canBus</p>
<div class="fragment"><div class="line">canProt.<a class="code hl_function" href="class_lib_can_prot_send.html#afe976083bb7a0ab00cc3e27ddcadbdd9">setCanBusDriver</a>(&amp;canBus);</div>
<div class="line"><span class="keywordtype">bool</span> status = canProt.<a class="code hl_function" href="class_lib_can_prot_send.html#aa038780e5c48c6515240ae5aea72cc31">begin</a>();</div>
<div class="ttc" id="aclass_lib_can_prot_send_html_aa038780e5c48c6515240ae5aea72cc31"><div class="ttname"><a href="class_lib_can_prot_send.html#aa038780e5c48c6515240ae5aea72cc31">LibCanProtSend::begin</a></div><div class="ttdeci">bool begin(void)</div><div class="ttdef"><b>Definition</b> LibCan.cpp:113</div></div>
<div class="ttc" id="aclass_lib_can_prot_send_html_afe976083bb7a0ab00cc3e27ddcadbdd9"><div class="ttname"><a href="class_lib_can_prot_send.html#afe976083bb7a0ab00cc3e27ddcadbdd9">LibCanProtSend::setCanBusDriver</a></div><div class="ttdeci">void setCanBusDriver(LibCan2515 *p_canBus)</div><div class="ttdef"><b>Definition</b> LibCan.h:154</div></div>
</div><!-- fragment --><p>Ensuite, l'envoi des commandes se fait en utilisant les commandes du type <code>canProt.sendSetxxx(xxx)</code><br  />
 Par exemple la commande <code>canProt.sendSetRelay(2,HIGH)</code> permet d'activer le relai n°2 du robot</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Mise en oeuvre de la classe LibCanProtRecv</h2>
<p>La classe <a class="el" href="class_lib_can_prot_recv.html">LibCanProtRecv</a> est aussi générique et à besoin de connaitre l'objet en charge de la gestion des couches basses, mais aussi des objets en charge de la gestion des éléments du robot (moteur, GPIO, détecteur de couleur, ...)<br  />
</p>
<p>Une initialisation typique est donc la suivante :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_lib_can_8h.html">LibCan.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#define CAN_BUS_CS_PIN 49</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="class_lib_can2515.html">LibCan2515</a>     canBus(CAN_BUS_CS_PIN);</div>
<div class="line"><a class="code hl_class" href="class_lib_can_prot_send.html">LibCanProtSend</a> canProt;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_lib_moteur_8h.html">LibMoteur.h</a>&quot;</span></div>
<div class="line"><a class="code hl_class" href="class_lib_moteur.html">LibMoteur</a>  moteur1(1,2, 3, 4, 5,6);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_lib_color_8h.html">LibColor.h</a>&quot;</span></div>
<div class="line"><a class="code hl_class" href="class_lib_tcs3472.html">LibTcs3472</a> color;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="_lib_gpio_8h.html">LibGpio.h</a>&quot;</span></div>
<div class="line"><a class="code hl_class" href="class_lib_gpio.html">LibGpio</a> gpio(gpioPinRobotTeamB, nbGpioRobotTeamB);</div>
<div class="ttc" id="a_lib_color_8h_html"><div class="ttname"><a href="_lib_color_8h.html">LibColor.h</a></div><div class="ttdoc">Le fichier de définition des classes gérant les détecteurs de couleur.</div></div>
<div class="ttc" id="a_lib_gpio_8h_html"><div class="ttname"><a href="_lib_gpio_8h.html">LibGpio.h</a></div><div class="ttdoc">Le fichier de définition de la classe LibGpio.</div></div>
<div class="ttc" id="a_lib_moteur_8h_html"><div class="ttname"><a href="_lib_moteur_8h.html">LibMoteur.h</a></div><div class="ttdoc">Le fichier de définition de la classe LibMoteur.</div></div>
<div class="ttc" id="aclass_lib_gpio_html"><div class="ttname"><a href="class_lib_gpio.html">LibGpio</a></div><div class="ttdoc">Gestion des Entrées/Sorties d'un PAMI.</div><div class="ttdef"><b>Definition</b> LibGpio.h:47</div></div>
<div class="ttc" id="aclass_lib_moteur_html"><div class="ttname"><a href="class_lib_moteur.html">LibMoteur</a></div><div class="ttdoc">Gestion de moteurs.</div><div class="ttdef"><b>Definition</b> LibMoteur.h:51</div></div>
<div class="ttc" id="aclass_lib_tcs3472_html"><div class="ttname"><a href="class_lib_tcs3472.html">LibTcs3472</a></div><div class="ttdoc">Description de la librairie de gestion d'un détecteur de couleur TCS3472.</div><div class="ttdef"><b>Definition</b> LibColor.h:33</div></div>
</div><!-- fragment --><p>Puis dans le setup(), il faut donner à l'objet canProt la référence des différents objets</p>
<div class="fragment"><div class="line">canProt.<a class="code hl_function" href="class_lib_can_prot_send.html#afe976083bb7a0ab00cc3e27ddcadbdd9">setCanBusDriver</a>(&amp;canBus);</div>
<div class="line"><span class="keywordtype">bool</span> status = canProt.<a class="code hl_function" href="class_lib_can_prot_send.html#aa038780e5c48c6515240ae5aea72cc31">begin</a>();</div>
<div class="line">canProt.setMoteurDriver(0,&amp;moteur1);</div>
<div class="line">canProt.setColorDriver(&amp;color);</div>
<div class="line">canProt.setGpioDriver(&amp;gpio);</div>
</div><!-- fragment --><p>La fonction <code>canProt.gestionMessage()</code> gère l'ensemble des commandes et s'appuie sur les objets passés en référence pour les exécutées.<br  />
 La fonction <code>loop()</code> devient simplement la suivante :</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> loop(<span class="keywordtype">void</span>){</div>
<div class="line">  color.<a class="code hl_function" href="class_lib_tcs3472.html#ac03e686156062b2c66a45ee4e5026d3c">gestion</a>();</div>
<div class="line">  canProt.gestionMessage();</div>
<div class="line">}</div>
<div class="ttc" id="aclass_lib_tcs3472_html_ac03e686156062b2c66a45ee4e5026d3c"><div class="ttname"><a href="class_lib_tcs3472.html#ac03e686156062b2c66a45ee4e5026d3c">LibTcs3472::gestion</a></div><div class="ttdeci">void gestion(void)</div><div class="ttdef"><b>Definition</b> LibColor.cpp:55</div></div>
</div><!-- fragment --><p>A noter la présence de l'appel à la fonction gestion de l'objet color. En effet l'objet color nécessite un appel régulier pour être opérationnel </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
